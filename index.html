function calc() {
    const S = parseFloat(document.getElementById('spot').value) || 0;
    const EMA = parseFloat(document.getElementById('ema').value) || 0;
    const DTE = parseFloat(document.getElementById('dte').value) || 1;
    const zBase = parseFloat(document.getElementById('zBase').value) || 2.0;
    const v = parseInt(document.getElementById('vSlider').value) || 12;
    const pW = parseInt(document.getElementById('pSlider').value) / 100;

    const distPct = ((S - EMA) / EMA) * 100;
    const adj = Math.max(-0.5, Math.min(0.5, distPct * 0.1));
    const finalZ = zBase + adj;
    const IVE = ((parseFloat(document.getElementById('ivw').value)/100)*pW) + ((parseFloat(document.getElementById('ivd').value)/100)*(1-pW));
    
    let rawS = S * (1 + (IVE * Math.sqrt(DTE/365) * finalZ));
    const realStrike = Math.round(rawS / 25) * 25;
    const colorStatus = distPct > 0.3 ? 'var(--high)' : (distPct < -0.3 ? 'var(--low)' : '#94a3b8');

    document.getElementById('outAlgo').innerHTML = `
        <label>STRIKE SUGERIDO (ALGO):</label>
        <span class="highlight">$${realStrike.toLocaleString()}</span>
        <div style="font-size:0.75em; margin-top:8px;">
            Elasticidad: <b style="color:${colorStatus}">${distPct.toFixed(2)}%</b> | 
            Z-Final: <b style="color:${colorStatus}">${finalZ.toFixed(2)}</b>
        </div>
    `;

    // --- ANÁLISIS FINANCIERO DETALLADO ---
    const stkF = parseFloat(document.getElementById('stkBinance').value) || realStrike;
    const aprD = parseFloat(document.getElementById('aprDual').value) || 0;
    const apyS = parseFloat(document.getElementById('apyStaking').value) || 3.0;
    
    // Cálculo de APY Compuesto (Reinvertido cada ciclo de DTE)
    const periodsPerYear = 365 / DTE;
    const dualAPY = (Math.pow(1 + (aprD/100)/periodsPerYear, periodsPerYear) - 1) * 100;
    
    const mult = (dualAPY / apyS);
    const tScore = Math.log(stkF/S) / (IVE * Math.sqrt(DTE/365));
    const probExito = tCDF(tScore, v) * 100;
    const probP = 100 - probExito;

    // Lógica del Semáforo
    let semColor, msg, advice;
    if (probP <= 4.5) {
        semColor = 'var(--low)';
        msg = "EXCELENTE: RIESGO MÍNIMO";
        advice = "El Strike está fuera del rango de volatilidad probable. Alta seguridad.";
    } else if (probP <= 9) {
        semColor = 'var(--mid)';
        msg = "MODERADO: VIGILAR TENDENCIA";
        advice = "Riesgo aceptable por APR alto, pero vulnerable a mechazos.";
    } else {
        semColor = 'var(--high)';
        msg = "PELIGRO: ALTA PROB. CONVERSIÓN";
        advice = "El Strike es demasiado agresivo para la volatilidad actual.";
    }

    document.getElementById('outDual').innerHTML = `
        <div class="result-box" style="border-left: 5px solid ${semColor}">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div style="text-align:left">
                    <small style="color:#94a3b8">Prob. Éxito</small><br>
                    <b style="font-size:1.1em; color:var(--low)">${probExito.toFixed(2)}%</b>
                </div>
                <div style="text-align:right">
                    <small style="color:#94a3b8">Prob. Pérdida ETH</small><br>
                    <b style="font-size:1.1em; color:${semColor}">${probP.toFixed(2)}%</b>
                </div>
            </div>

            <div style="background:#1e293b; padding:10px; border-radius:8px; font-size:0.85em; margin-bottom:10px">
                <div class="stat-line"><span>APY Compuesto Real:</span><b>${dualAPY.toFixed(2)}%</b></div>
                <div class="stat-line"><span>Ventaja vs Staking:</span><b style="color:var(--primary)">${mult.toFixed(2)}x más rentable</b></div>
                <div class="stat-line"><span>Strike vs Spot:</span><b>+${((stkF/S - 1)*100).toFixed(2)}% de distancia</b></div>
            </div>

            <div class="badge" style="background:${semColor}22; color:${semColor}; border: 1px solid ${semColor}">
                ${msg}
                <div style="font-size:0.8em; font-weight:normal; margin-top:4px; opacity:0.9">${advice}</div>
            </div>
            
            <div style="font-size:0.65em; color:#64748b; text-align:center; margin-top:10px">
                Veredicto basado en T-Student (v=${v}) y Sesgo EMA.
            </div>
        </div>
    `;
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH Sentinel v6.4 - Hybrid Engine</title>
    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --low: #4ade80; --mid: #facc15; --high: #f87171; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 10px; display: flex; justify-content: center; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; width: 100%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .btn-sync { width: 100%; background: var(--primary); color: var(--bg); border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        label { display: block; font-size: 0.75em; color: #94a3b8; margin-bottom: 4px; }
        input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #475569; background: var(--bg); color: #fff; box-sizing: border-box; }
        input:disabled { opacity: 0.4; cursor: not-allowed; }
        .mode-selector { display: flex; align-items: center; gap: 10px; background: #334155; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85em; }
        .elastic-badge { padding: 6px; border-radius: 6px; font-size: 0.75em; text-align: center; margin-bottom: 10px; border: 1px solid #475569; }
        .result-box { margin-top: 15px; padding: 15px; border-radius: 10px; background: #334155; border-left: 5px solid var(--primary); }
        .highlight { color: var(--primary); font-weight: bold; font-size: 1.3em; display: block; }
    </style>
</head>
<body>

<div class="card">
    <button class="btn-sync" onclick="fetchMarket()">ðŸ”„ SINCRONIZAR MERCADO</button>
    
    <div class="mode-selector">
        <input type="checkbox" id="autoATR" checked onchange="toggleATRFields()">
        <label for="autoATR" style="margin:0; color:white; cursor:pointer;">Calcular ATRs automÃ¡ticamente (Binance)</label>
    </div>

    <div id="elasticity" class="elastic-badge">Sincroniza para ver elasticidad...</div>

    <div class="row">
        <div class="col"><label>Spot ETH</label><input type="number" id="spot" oninput="calc()"></div>
        <div class="col"><label>EMA 20 (4H)</label><input type="number" id="ema" oninput="calc()"></div>
    </div>

    <div class="row">
        <div class="col"><label>ATR Diario (D)</label><input type="number" id="atrd" value="85" oninput="calc()" disabled></div>
        <div class="col"><label>ATR Semanal (W)</label><input type="number" id="atrw" value="450" oninput="calc()" disabled></div>
    </div>

    <div class="row">
        <div class="col"><label>DTE (DÃ­as)</label><input type="number" id="dte" value="2" oninput="calc()"></div>
        <div class="col"><label>Base Z-Score</label><input type="number" id="zBase" value="2.0" step="0.1" oninput="calc()"></div>
    </div>

    <div class="row">
        <div class="col"><label>IV Diaria %</label><input type="number" id="ivd" value="53" oninput="calc()"></div>
        <div class="col"><label>IV Semanal %</label><input type="number" id="ivw" value="129" oninput="calc()"></div>
    </div>

    <div class="result-box" id="out"></div>
</div>

<script>
function studentT6(t) {
    let x = t / Math.sqrt(6);
    return 0.5 + (1/Math.PI) * (Math.atan(x) + (x/((1+x*x)*3)) * (1 + 2/(3*(1+x*x))));
}

function toggleATRFields() {
    const isAuto = document.getElementById('autoATR').checked;
    document.getElementById('atrd').disabled = isAuto;
    document.getElementById('atrw').disabled = isAuto;
}

async function fetchMarket() {
    try {
        const isAuto = document.getElementById('autoATR').checked;
        
        // 1. Spot
        const p = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT').then(r => r.json());
        document.getElementById('spot').value = parseFloat(p.price).toFixed(2);

        // 2. EMA 20 (4h)
        const kRes = await fetch('https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=4h&limit=50').then(r => r.json());
        let ema = parseFloat(kRes[0][4]);
        const k = 2 / (20 + 1);
        kRes.forEach(c => { ema = (parseFloat(c[4]) - ema) * k + ema; });
        document.getElementById('ema').value = ema.toFixed(2);

        if (isAuto) {
            // 3. ATR Diario (14d)
            const dK = await fetch('https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1d&limit=15').then(r => r.json());
            let sD = 0; dK.slice(0,14).forEach(k => sD += (k[2]-k[3]));
            document.getElementById('atrd').value = (sD/14).toFixed(2);

            // 4. ATR Semanal (14w)
            const wK = await fetch('https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1w&limit=15').then(r => r.json());
            let sW = 0; wK.slice(0,14).forEach(k => sW += (k[2]-k[3]));
            document.getElementById('atrw').value = (sW/14).toFixed(2);
        }
        
        calc();
    } catch(e) { console.error(e); }
}

function calc() {
    const S = parseFloat(document.getElementById('spot').value) || 0;
    const EMA = parseFloat(document.getElementById('ema').value) || 0;
    const DTE = parseFloat(document.getElementById('dte').value) || 1;
    const zBase = parseFloat(document.getElementById('zBase').value) || 1;
    const ATRD = parseFloat(document.getElementById('atrd').value) || 0;
    const ATRW = parseFloat(document.getElementById('atrw').value) || 0;
    
    // Elasticidad EMA
    const distPct = ((S - EMA) / EMA) * 100;
    let adjustment = distPct * 0.1;
    adjustment = Math.max(-0.5, Math.min(0.5, adjustment));
    const finalZ = zBase + adjustment;

    // IV Ponderada y Confluencia
    const IVE = ((parseFloat(document.getElementById('ivw').value)/100)*0.75) + ((parseFloat(document.getElementById('ivd').value)/100)*0.25);
    const ATRE = ((ATRW / 7) * 0.75) + (ATRD * 0.25);

    // Strike Ã“ptimo (Mayor entre ATR e IV)
    const sATR = S + (ATRE * DTE * finalZ);
    const sIV = S * (1 + (IVE * Math.sqrt(DTE/365) * finalZ));
    const finalV = Math.max(sATR, sIV);
    
    const tScore = (finalV - S) / (S * IVE * Math.sqrt(DTE/365));
    const probExito = studentT6(tScore) * 100;
    const probPerdida = 100 - probExito;

    const badge = document.getElementById('elasticity');
    badge.innerHTML = `Distancia EMA: <b>${distPct.toFixed(2)}%</b> | Ajuste Z: <b>${adjustment >= 0 ? '+' : ''}${adjustment.toFixed(2)}</b>`;
    badge.style.color = distPct > 0 ? 'var(--high)' : 'var(--low)';

    const rCol = probPerdida < 4 ? 'var(--low)' : (probPerdida < 8 ? 'var(--mid)' : 'var(--high)');

    document.getElementById('out').innerHTML = `
        <label>STRIKE SUGERIDO:</label>
        <span class="highlight">$${finalV.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</span>
        <hr style="border:0; border-top:1px solid #475569; margin:10px 0">
        <div style="font-size:0.85em">
            Z Final: <b>${finalZ.toFixed(2)}</b> | Ã‰xito: <span style="color:var(--low)">${probExito.toFixed(2)}%</span><br>
            Prob. Perder ETH: <span style="color:${rCol}; font-weight:bold;">${probPerdida.toFixed(2)}%</span>
        </div>
    `;
}
window.onload = fetchMarket;
</script>
</body>
</html>

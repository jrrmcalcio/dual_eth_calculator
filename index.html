<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH Sentinel v7.3 - Full Suite</title>
    <style>
        :root { --primary: #38bdf8; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --low: #4ade80; --mid: #facc15; --high: #f87171; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 10px; display: flex; justify-content: center; }
        .card { background: var(--card); padding: 20px; border-radius: 16px; width: 100%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; background: #0f172a; padding: 5px; border-radius: 10px; }
        .tab-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; background: none; color: #94a3b8; cursor: pointer; font-weight: bold; font-size: 0.8em; }
        .tab-btn.active { background: var(--primary); color: var(--bg); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn-sync { width: 100%; background: var(--primary); color: var(--bg); border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .trend-indicator { padding: 8px; border-radius: 8px; text-align: center; font-size: 0.8em; font-weight: bold; margin-bottom: 15px; border: 2px solid #475569; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        .col { flex: 1; }
        label { display: block; font-size: 0.75em; color: #94a3b8; margin-bottom: 4px; }
        input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #475569; background: var(--bg); color: #fff; box-sizing: border-box; }
        .slider-container { background: #334155; padding: 12px; border-radius: 10px; margin-bottom: 10px; border: 1px solid #475569; }
        input[type="range"] { width: 100%; accent-color: var(--primary); cursor: pointer; margin-top: 10px; }
        .result-box { margin-top: 15px; padding: 15px; border-radius: 10px; background: #334155; border-left: 5px solid var(--primary); }
        .highlight { color: var(--primary); font-weight: bold; font-size: 1.4em; display: block; }
        .badge { display: block; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 12px; }
        .stat-line { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85em; }
    </style>
</head>
<body>

<div class="card">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('algo')">ESTRATEGIA</button>
        <button class="tab-btn" onclick="openTab('dual')">ANALISTA</button>
    </div>

    <button class="btn-sync" onclick="fetchMarket()">ðŸ”„ ACTUALIZAR MERCADO</button>
    <div id="trendLabel" class="trend-indicator">Sincroniza para iniciar...</div>

    <div id="algo" class="tab-content active">
        <div class="slider-container">
            <div style="display:flex; justify-content: space-between; font-size: 0.8em;">
                <span>Diario: <b id="valD">25%</b></span>
                <span>Semanal: <b id="valW">75%</b></span>
            </div>
            <input type="range" id="pSlider" min="0" max="100" value="75" oninput="updateSliders()">
        </div>

        <div class="slider-container" style="border-color: var(--primary);">
            <div style="display:flex; justify-content: space-between; font-size: 0.8em;">
                <span>DistribuciÃ³n (Libertad):</span>
                <b id="valV" style="color:var(--primary)">12</b>
            </div>
            <input type="range" id="vSlider" min="2" max="100" value="12" oninput="updateSliders()">
        </div>

        <div class="row">
            <div class="col"><label>Spot ETH</label><input type="number" id="spot" oninput="calc()"></div>
            <div class="col"><label>EMA 20 (4H)</label><input type="number" id="ema" oninput="calc()"></div>
        </div>

        <div class="row">
            <div class="col"><label>DTE (DÃ­as)</label><input type="number" id="dte" value="2" oninput="calc()"></div>
            <div class="col"><label>Base Z-Score</label><input type="number" id="zBase" value="2.0" step="0.1" oninput="calc()"></div>
        </div>

        <div class="row">
            <div class="col"><label>IV D %</label><input type="number" id="ivd" value="45" oninput="calc()"></div>
            <div class="col"><label>IV W %</label><input type="number" id="ivw" value="55" oninput="calc()"></div>
        </div>

        <div class="row" style="background:#1e293b; padding:10px; border-radius:8px;">
            <div class="col"><label>ATR D</label><input type="number" id="atrd" value="85" oninput="calc()"></div>
            <div class="col"><label>ATR W</label><input type="number" id="atrw" value="450" oninput="calc()"></div>
        </div>

        <div class="result-box" id="outAlgo"></div>
    </div>

    <div id="dual" class="tab-content">
        <div class="row">
            <div class="col"><label>Strike Binance</label><input type="number" id="stkBinance" oninput="calc()"></div>
            <div class="col"><label>APR Dual %</label><input type="number" id="aprDual" value="12" oninput="calc()"></div>
        </div>
        <div class="row"><div class="col"><label>Staking APY %</label><input type="number" id="apyStaking" value="3.0" oninput="calc()"></div></div>
        <div id="outDual"></div>
    </div>
</div>

<script>
function tCDF(t, v) {
    const x = t / Math.sqrt(v);
    if (v > 40) {
        return 0.5 * (1 + Math.tanh(0.79788456 * (t + 0.044715 * Math.pow(t, 3))));
    }
    return 0.5 + (Math.atan(x) / Math.PI) + (x / (Math.PI * v * (1 + x * x / v)));
}

function openTab(name) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    event.currentTarget.classList.add('active');
    calc();
}

function updateSliders() {
    document.getElementById('valW').innerText = document.getElementById('pSlider').value + '%';
    document.getElementById('valD').innerText = (100 - document.getElementById('pSlider').value) + '%';
    document.getElementById('valV').innerText = document.getElementById('vSlider').value;
    calc();
}

async function fetchMarket() {
    try {
        const pRes = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=ETHUSDT').then(r => r.json());
        const spot = parseFloat(pRes.price);
        document.getElementById('spot').value = spot.toFixed(2);
        const kRes = await fetch('https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=4h&limit=50').then(r => r.json());
        let ema = parseFloat(kRes[0][4]); const k = 2/21;
        kRes.forEach(c => { ema = (parseFloat(c[4]) - ema) * k + ema; });
        document.getElementById('ema').value = ema.toFixed(2);
        
        const dK = await fetch('https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1d&limit=15').then(r => r.json());
        let sD = 0; dK.slice(0,14).forEach(v => sD += (v[2]-v[3]));
        document.getElementById('atrd').value = (sD/14).toFixed(2);

        const wK = await fetch('https://api.binance.com/api/v3/klines?symbol=ETHUSDT&interval=1w&limit=15').then(r => r.json());
        let sW = 0; wK.slice(0,14).forEach(v => sW += (v[2]-v[3]));
        document.getElementById('atrw').value = (sW/14).toFixed(2);

        const tLabel = document.getElementById('trendLabel');
        const diff = ((spot - ema) / ema) * 100;
        if(diff > 0.3) { tLabel.innerText = "TENDENCIA: ALCISTA (PELIGRO)"; tLabel.style.borderColor = "var(--high)"; tLabel.style.color = "var(--high)"; }
        else if(diff < -0.3) { tLabel.innerText = "TENDENCIA: BAJISTA (SEGURO)"; tLabel.style.borderColor = "var(--low)"; tLabel.style.color = "var(--low)"; }
        else { tLabel.innerText = "TENDENCIA: LATERAL"; tLabel.style.borderColor = "#475569"; tLabel.style.color = "#94a3b8"; }
        calc();
    } catch(e) { console.error(e); }
}

function calc() {
    const S = parseFloat(document.getElementById('spot').value) || 0;
    const EMA = parseFloat(document.getElementById('ema').value) || 0;
    const DTE = parseFloat(document.getElementById('dte').value) || 1;
    const zBase = parseFloat(document.getElementById('zBase').value) || 2.0;
    const v = parseInt(document.getElementById('vSlider').value) || 12;
    const pW = parseInt(document.getElementById('pSlider').value) / 100;

    const distPct = ((S - EMA) / EMA) * 100;
    const adj = Math.max(-0.5, Math.min(0.5, distPct * 0.1));
    const finalZ = zBase + adj;
    const IVE = ((parseFloat(document.getElementById('ivw').value)/100)*pW) + ((parseFloat(document.getElementById('ivd').value)/100)*(1-pW));
    const ATRE = ((parseFloat(document.getElementById('atrw').value)/7)*pW) + (parseFloat(document.getElementById('atrd').value)*(1-pW));
    
    let rawS = Math.max(S + (ATRE * DTE * finalZ), S * (1 + (IVE * Math.sqrt(DTE/365) * finalZ)));
    const realStrike = Math.round(rawS / 25) * 25;
    const colorStatus = distPct > 0.3 ? 'var(--high)' : (distPct < -0.3 ? 'var(--low)' : '#94a3b8');

    document.getElementById('outAlgo').innerHTML = `
        <label>STRIKE SUGERIDO (ALGO):</label>
        <span class="highlight">$${realStrike.toLocaleString()}</span>
        <div style="font-size:0.75em; margin-top:8px;">
            Elasticidad: <b style="color:${colorStatus}">${distPct.toFixed(2)}%</b> | 
            Z-Final: <b style="color:${colorStatus}">${finalZ.toFixed(2)}</b>
        </div>
    `;

    const stkF = parseFloat(document.getElementById('stkBinance').value) || realStrike;
    const aprD = parseFloat(document.getElementById('aprDual').value) || 0;
    const apyS = parseFloat(document.getElementById('apyStaking').value) || 3.0;
    
    const periodsPerYear = 365 / DTE;
    const dualAPY = (Math.pow(1 + (aprD/100)/periodsPerYear, periodsPerYear) - 1) * 100;
    const mult = (dualAPY / apyS);
    const tScore = Math.log(stkF/S) / (IVE * Math.sqrt(DTE/365));
    const probExito = tCDF(tScore, v) * 100;
    const probP = 100 - probExito;

    let semColor, msg, advice;
    if (probP <= 4.5) { semColor = 'var(--low)'; msg = "EXCELENTE: RIESGO MÃNIMO"; advice = "Strike fuera de volatilidad probable."; }
    else if (probP <= 9) { semColor = 'var(--mid)'; msg = "MODERADO: VIGILAR"; advice = "Riesgo aceptable por APR, pero vulnerable."; }
    else { semColor = 'var(--high)'; msg = "PELIGRO: CONVERSIÃ“N"; advice = "Strike demasiado agresivo para hoy."; }

    document.getElementById('outDual').innerHTML = `
        <div class="result-box" style="border-left: 5px solid ${semColor}">
            <div class="stat-line"><span>Prob. Ã‰xito: <b style="color:var(--low)">${probExito.toFixed(2)}%</b></span> <span>PÃ©rdida ETH: <b style="color:${semColor}">${probP.toFixed(2)}%</b></span></div>
            <div style="background:#1e293b; padding:10px; border-radius:8px; margin:10px 0;">
                <div class="stat-line"><span>APY Compuesto:</span><b>${dualAPY.toFixed(2)}%</b></div>
                <div class="stat-line"><span>Ventaja vs Staking:</span><b style="color:var(--primary)">${mult.toFixed(2)}x mÃ¡s</b></div>
                <div class="stat-line"><span>Distancia Strike:</span><b>+${((stkF/S - 1)*100).toFixed(2)}%</b></div>
            </div>
            <div class="badge" style="background:${semColor}22; color:${semColor}; border: 1px solid ${semColor}">
                ${msg}<br><small style="font-weight:normal; opacity:0.8">${advice}</small>
            </div>
        </div>
    `;
}
window.onload = fetchMarket;
</script>
</body>
</html>
